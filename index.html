<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Reptile Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src='events.json'></script>
    <script src='blogs.json'></script>

    <style>
        #map { height: 450px; }
        body { background-color: #f8f8f8; }
        .hero-bg { background: linear-gradient(to right, #4CAF50, #8BC34A); }
    </style>
</head>
<body>

    <div id="app">
        <main-app></main-app>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed } = Vue;

        // Custom Components for each section
        const Header = {
            template: `
                <header>
                    <nav id="home" class="light-green darken-4 z-depth-2">
                        <div class="nav-wrapper container">
                            <a href="#" class="brand-logo">Reptilemap</a>
                            <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
                            <ul class="right hide-on-med-and-down">
                                <li v-for="link in links">
                                    <a :href="link.url">{{ link.text }}</a>
                                </li>
                            </ul>
                        </div>
                    </nav>
                    <ul class="sidenav" id="mobile-demo">
                        <li v-for="link in links">
                            <a :href="link.url">{{ link.text }}</a>
                        </li>
                    </ul>
                </header>
            `,
            data() {
                return {
                    links: [
                        { text: 'About Us', url: '#about' },
                        { text: 'Map', url: '#map-section' },
                        { text: 'Projects', url: '#projects' },
                        { text: 'Stories', url: '#stories' },
                        { text: 'Events', url: '#events' },
                        { text: 'Contact', url: '#contact' }
                    ]
                };
            },
            mounted() {
                // Initialize the mobile sidenav
                M.Sidenav.init(document.querySelector('.sidenav'));
            }
        };

        const Hero = {
            template: `
                <section class="hero-bg white-text section no-pad-bot">
                    <div class="container center-align">
                        <br><br>
                        <h1 class="header light-green-text text-lighten-5">Mapping the World's Reptiles</h1>
                        <div class="row center">
                            <h5 class="header col s12 light">A global initiative to understand reptile biogeography, monitor populations, and inform conservation strategies.</h5>
                        </div>
                        <div class="row center">
                            <a href="#map-section" class="btn-large waves-effect waves-light white light-green-text text-darken-4">View Map</a>
                        </div>
                        <br><br>
                    </div>
                </section>
            `
        };

        const Conference = {
            template: `
                <section id="projects" class="section scrollspy">
                    <div class="container center-align">
                        <h2 class="light-green-text text-darken-4">ReptileWorld 2025</h2>
                        <h4 class="light-gray-text">October 26 @1pm on zoom</h4>
                        <p class="flow-text">
                            Join us for a day of ...
                        </p>
                        <div class="row">
                            <div v-for="project in projects" :key="project.title" class="col s12 m6 l4">
                                <div class="card small light-green lighten-5">
                                    <div class="card-content light-green-text text-darken-4">
                                        <h4 class="card-title">{{ project.title }}</h4>
                                        <p>{{ project.description }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `,
            data() {
                return {
                    projects: [
                        { title: 'Keynote address', description: 'Importance of conservation, citizen science and empowering students with AI vibe coding.' },
                        { title: 'Panel discussions', description: 'blah blah.' },
                        { title: 'Q&A', description: 'blah blah.' }
                    ]
                };
            }
        };

        const About = {
            template: `
                <section id="about" class="section scrollspy grey lighten-3">
                    <div class="container">
                        <div class="row">
                            <div class="col s12 center">
                                <h2 class="light-green-text text-darken-4">About Us</h2>
                                <p class="flow-text">
                                    The Reptile Map is dedicated to creating a comprehensive, interactive, and accessible global mapping platform that documents the distribution and diversity of reptile species around the world. We aim to establish a global network of citizen scientists and researchers to gather crucial data.
                                </p>
                                <p class="flow-text">
                                    Our mission is to be a valuable resource for understanding reptile biogeography, monitoring population trends, identifying conservation hotspots, and informing strategies for the protection and management of reptiles and their habitats.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
            `
        };

        const MapContainer = {
            template: `
                <section id="map-section" class="section scrollspy">
                    <div class="container">
                        <h2 class="light-green-text text-darken-4 center">Reptilemap</h2>
                        <div class="card z-depth-2">
                            <div class="card-content">
                                <div id="map"></div>
                            </div>
                        </div>
                    </div>
                </section>
            `,
            props: ['observations'],
            data() {
                return {
                    map: null,
                    markers: []
                };
            },
            watch: {
                observations: {
                    handler(newObservations) {
                        this.updateMapMarkers(newObservations);
                    },
                    deep: true,
                    immediate: true
                }
            },
            mounted() {
                this.map = L.map('map').setView([0, 0], 2);
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(this.map);

                this.$emit('map-ready', this.map);
                this.updateMapMarkers(this.observations);
            },
            methods: {
                updateMapMarkers(obs) {
                    this.markers.forEach(marker => this.map.removeLayer(marker));
                    this.markers = [];
                    obs.forEach(observation => {
                        const { lat, lon, species } = observation;
                        if (lat && lon) {
                            const marker = L.marker([lat, lon]).addTo(this.map);
                            marker.bindPopup(`<h3>${species}</h3>`).openPopup();
                            this.markers.push(marker);
                        }
                    });

                    if (this.markers.length > 0) {
                        const group = new L.featureGroup(this.markers);
                        this.map.fitBounds(group.getBounds());
                    }
                }
            }
        };

        const ObservationForm = {
            template: `
                <section id="obs" class="section scrollspy">
                    <div class="container">
                        <div class="card">
                            <div class="card-content">
                                <span class="card-title light-green-text text-darken-4">Submit Observation</span>
                                <form @submit.prevent="submitForm">
                                    <div class="row">
                                        <div class="input-field col s12 m6">
                                            <input v-model.number="form.latitude" id="latitude" type="number" step="any" required>
                                            <label for="latitude">Latitude</label>
                                        </div>
                                        <div class="input-field col s12 m6">
                                            <input v-model.number="form.longitude" id="longitude" type="number" step="any" required>
                                            <label for="longitude">Longitude</label>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="input-field col s12">
                                            <input v-model="form.species" id="species" type="text" required>
                                            <label for="species">Species</label>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="input-field col s12">
                                            <input v-model="form.link" id="link" type="url">
                                            <label for="link">Link (URL)</label>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="input-field col s12">
                                            <input v-model="form.image" id="image" type="url">
                                            <label for="image">Image (URL)</label>
                                        </div>
                                    </div>
                                    <div class="row center">
                                        <button type="submit" class="btn waves-effect waves-light light-green darken-4">
                                            Submit
                                            <i class="material-icons right">send</i>
                                        </button>
                                    </div>
                                    <p class="center-align" v-if="message">
                                        <span :class="messageClass">{{ message }}</span>
                                    </p>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>
            `,
            props: ['clickedCoords'],
            emits: ['add-observation'],
            data() {
                return {
                    form: {
                        latitude: '',
                        longitude: '',
                        species: '',
                        link: '',
                        image: ''
                    },
                    message: '',
                    messageClass: ''
                };
            },
            watch: {
                clickedCoords(newCoords) {
                    if (newCoords) {
                        this.form.latitude = newCoords.lat.toFixed(4);
                        this.form.longitude = newCoords.lng.toFixed(4);

                        M.updateTextFields(); // Required for Materialize to update input fields
                    }
                }
            },
            methods: {
                async submitForm() {
                    this.message = 'Submitting data...';
                    this.messageClass = 'grey-text';
                    const formData = {
                        latitude: this.form.latitude,
                        longitude: this.form.longitude,
                        species: this.form.species,
                        link: this.form.link,
                        image: this.form.image
                    };

                    try {
                        const response = await fetch('https://script.google.com/macros/s/AKfycbzXGg7JBAT3tzZs2H8Mf7I69Z9QXcqaLeWxfuwfmbgRmW-NZkU1CHa4SKbgXJPAbn7LMA/exec', {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });

                        this.$emit('add-observation', formData);
                        this.message = 'Data successfully submitted!';
                        this.messageClass = 'green-text';
                        this.resetForm();
                    } catch (error) {
                        console.error('Error:', error);
                        this.message = 'Error submitting data. Please try again.';
                        this.messageClass = 'red-text';
                    }
                },
                resetForm() {
                    this.form.latitude = '';
                    this.form.longitude = '';
                    this.form.species = '';
                    this.form.link = '';
                    this.form.image = '';

                    M.updateTextFields(); // Required for Materialize to update input fields
                }
            }
        };

        const Projects = {
            template: `
                <section id="projects" class="section scrollspy grey lighten-3">
                    <div class="container center-align">
                        <h2 class="light-green-text text-darken-4">Our Projects</h2>
                        <p class="flow-text">
                            We are involved in various projects aimed at reptile research, habitat restoration, and community engagement. From tracking endangered species to educating local communities, our work spans the globe.
                        </p>
                        <div class="row">
                            <div v-for="project in projects" :key="project.title" class="col s12 m6 l4">
                                <div class="card small light-green lighten-5">
                                    <div class="card-content light-green-text text-darken-4">
                                        <h4 class="card-title">{{ project.title }}</h4>
                                        <p>{{ project.description }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `,
            data() {
                return {
                    projects: [
                        { title: 'Species Monitoring', description: 'Implementing advanced tracking and monitoring programs for vulnerable reptile populations across diverse ecosystems.' },
                        { title: 'Habitat Restoration', description: 'Working to restore critical reptile habitats, ensuring safe and thriving environments for various species.' },
                        { title: 'Citizen Science', description: 'Engaging the public in data collection efforts, transforming everyday citizens into vital contributors to conservation.' }
                    ]
                };
            }
        };

        const Stories = {
            template: `
                <section id="stories" class="section scrollspy">
                    <div class="container center-align">
                        <h2 class="light-green-text text-darken-4">Stories</h2>
                        <div class="row">
                            <div v-for="(story,index) in stories.slice(0,3)" :key="index" class="col s12 m6 l4">
                                <div class="card medium">
                                    <div class="card-image waves-effect waves-block waves-light">
                                        <img class="activator" :src="story.thumbnail">
                                    </div>
                                    <div class="card-content">
                                        <span class="card-title activator light-green-text text-darken-4">{{ story.title }}</span>
                                        <p><a :href="'stories.html?story=' + index">Read More</a></p>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- row -->
                        <div class='row'> 
                            <ul class="pagination">
                                <li v-for="(x, index) in stories" :key="index">
                                    <a :href="'stories.html?story=' + index">{{ index }}</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>
            `,
            data() {
                return { stories }
            }
        };

        const Events = {
            template: `
                <section id="events" class="section scrollspy grey lighten-3">
                    <div class="container center-align">
                        <h2 class="light-green-text text-darken-4">Events</h2>
                        <p class="flow-text">
                            Join us for our upcoming workshops, webinars, and field trips designed to educate and engage reptile enthusiasts and conservationists.
                        </p>
                        <div class="row">
                            <div v-for="event in events" :key="event.title" class="col s12 m6">
                                <div class="card large light-green lighten-5">
                                    <div class="card-content black-text left-align">
                                        <span class="card-title light-green-text text-darken-4">{{ event.title }}</span>
                                        <p><strong>Date:</strong> {{ event.date }}</p>
                                        <p><strong>Location:</strong> {{ event.location }}</p>
                                        <p>{{ event.description }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `,
            data() {
                return { events };
            }
        };

        const Contact = {
            template: `
                <section id="contact" class="section scrollspy">
                    <div class="container">
                        <div class="row">
                            <div class="col s12 center">
                                <h2 class="light-green-text text-darken-4">Contact Us</h2>
                                <p class="flow-text">
                                    Have questions, suggestions, or want to get involved? Reach out to us!
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <form @submit.prevent="submitContactForm" class="col s12">
                                <div class="card">
                                    <div class="card-content">
                                        <div class="row">
                                            <div class="input-field col s12">
                                                <i class="material-icons prefix">account_circle</i>
                                                <input v-model="form.name" id="name" type="text" class="validate">
                                                <label for="name">Your Name</label>
                                            </div>
                                            <div class="input-field col s12">
                                                <i class="material-icons prefix">email</i>
                                                <input v-model="form.email" id="email" type="email" class="validate">
                                                <label for="email">Your Email</label>
                                            </div>
                                            <div class="input-field col s12">
                                                <i class="material-icons prefix">mode_edit</i>
                                                <textarea v-model="form.message" id="message" class="materialize-textarea"></textarea>
                                                <label for="message">Your Message</label>
                                            </div>
                                        </div>
                                        <div class="row center">
                                            <button type="submit" class="btn-large waves-effect waves-light light-green darken-4">
                                                Send Message
                                                <i class="material-icons right">send</i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>
            `,
            data() {
                return {
                    form: { name: '', email: '', message: '' }
                };
            },
            methods: {
                submitContactForm() {
                    alert('Contact form submission simulated! Name: ' + this.form.name);
                }
            }
        };

        const Footer = {
            template: `
                <footer class="page-footer light-green darken-4">
                    <div class="container">
                        <div class="row">
                            <div class="col l6 s12">
                                <h5 class="white-text">The Reptile Map</h5>
                                <p class="grey-text text-lighten-4">A global initiative for reptile conservation.</p>
                            </div>
                            <div class="col l4 offset-l2 s12">
                                <h5 class="white-text">Links</h5>
                                <ul>
                                    <li><a class="grey-text text-lighten-3" href="#home">Home</a></li>
                                    <li><a class="grey-text text-lighten-3" href="#map-section">Map</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="footer-copyright light-green darken-3">
                        <div class="container">
                            © 2025 The Reptile Map. All rights reserved.
                        </div>
                    </div>
                </footer>
            `
        };

        // Main Application Component
        const MainApp = {
            components: { Header, Hero, Conference, About, MapContainer, ObservationForm, Projects, Stories, Events, Contact, Footer },
            template: `
                <div>
                    <Header />
                    <Hero />
                    <main>
                        <Conference />
                        <About />
                        <MapContainer
                            :observations="observations"
                            @map-ready="handleMapReady"
                        />
                        <ObservationForm
                            :clicked-coords="clickedCoords"
                            @add-observation="addObservation"
                        />
                        <Projects />
                        <Stories />
                        <Events />
                        <Contact />
                    </main>
                    <Footer />
                </div>
            `,
            data() {
                return {
                    observations: [],
                    clickedCoords: null,
                };
            },
            methods: {
                async fetchObservations() {
                    const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0CabXJ0prVhGGccFuidPRCP0YNj1Pv2xKEXgpCF9LTitRnEdDB_VlQXyJGnD-v1xeKEqMGkcpTQiR/pub?gid=0&single=true&output=csv';
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        const csvText = await response.text();
                        const lines = csvText.trim().split('\n').slice(1);
                        this.observations = lines.map(line => {
                            const [lat, lon, species, link, image] = line.split(',').map(d => d.trim());
                            return { lat: parseFloat(lat), lon: parseFloat(lon), species, link, image };
                        });
                    } catch (error) {
                        console.error("Failed to fetch observations:", error);
                    }
                },
                addObservation(newObs) {
                    this.observations.push({
                        lat: parseFloat(newObs.latitude),
                        lon: parseFloat(newObs.longitude),
                        species: newObs.species,
                        link: newObs.link,
                        image: newObs.image
                    });
                },
                handleMapReady(mapInstance) {
                    mapInstance.on('click', (e) => {
                        this.clickedCoords = { lat: e.latlng.lat, lng: e.latlng.lng };
                        L.popup()
                            .setLatLng(e.latlng)
                            .setContent("Clicked at: " + e.latlng.toString())
                            .openOn(mapInstance);
                    });
                },
            },
            mounted() {
                this.fetchObservations();
                M.AutoInit(); // Initialize all Materialize components
            }
        };

        createApp(MainApp).mount('#app');
    </script>
</body>
</html>